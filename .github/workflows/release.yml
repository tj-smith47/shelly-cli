# =============================================================================
# Release Workflow (Native CGO Builds)
# =============================================================================
# This workflow builds native binaries with CGO support for BLE on each platform.
# It's a workaround until GoReleaser Pro is available for split/merge builds.
#
# When you get GoReleaser Pro:
# 1. Disable this workflow (comment out the triggers)
# 2. Enable goreleaser-pro.yml (uncomment the triggers)
# 3. Add GORELEASER_KEY secret
# =============================================================================

name: Release

on:
  # Triggered by AutoTag workflow completion
  workflow_run:
    workflows:
      - "AutoTag"
    branches:
      - master
    types:
      - completed
  # Also triggered by manual tag push (for RC releases)
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pull-requests: read
  packages: write

env:
  GO_VERSION: "1.25.5"

jobs:
  # =============================================================================
  # Get tag name for all jobs
  # =============================================================================
  prepare:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      version: ${{ steps.get-tag.outputs.version }}
      should_run: ${{ steps.get-tag.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag
        id: get-tag
        run: |
          should_run=true
          if [ "${{ github.event_name }}" = "push" ]; then
            TAG="${{ github.ref_name }}"
          else
            # For workflow_run events, check if a tag exists at HEAD
            # (AutoTag skips if commit has #none)
            if ! git tag --points-at HEAD | grep -q .; then
              echo "No tag at HEAD - AutoTag likely skipped (commit has #none)"
              should_run=false
              TAG=""
            else
              TAG=$(git describe --tags --abbrev=0)
            fi
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "should_run=${should_run}" >> $GITHUB_OUTPUT

  # =============================================================================
  # Build job - runs on native platform runners for CGO support
  # =============================================================================
  build:
    needs: prepare
    if: ${{ needs.prepare.outputs.should_run == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux amd64 - native with CGO for BlueZ BLE
          - runner: ubuntu-latest
            goos: linux
            goarch: amd64
            cgo: 1
            artifact: shelly_linux_amd64
          # Linux arm64 - native with CGO for BlueZ BLE
          - runner: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
            cgo: 1
            artifact: shelly_linux_arm64
          # macOS amd64 - native with CGO for CoreBluetooth BLE
          - runner: macos-15-intel
            goos: darwin
            goarch: amd64
            cgo: 1
            artifact: shelly_darwin_amd64
          # macOS arm64 - native with CGO for CoreBluetooth BLE
          - runner: macos-latest
            goos: darwin
            goarch: arm64
            cgo: 1
            artifact: shelly_darwin_arm64
          # Windows amd64 - WinRT BLE (no CGO needed)
          - runner: windows-latest
            goos: windows
            goarch: amd64
            cgo: 0
            artifact: shelly_windows_amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install Linux BLE dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libbluetooth-dev

      - name: Build binary
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: ${{ matrix.cgo }}
          CC: ${{ matrix.cc }}
          TELEMETRY_ENDPOINT: ${{ secrets.TELEMETRY_ENDPOINT }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          COMMIT="${{ github.sha }}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          LDFLAGS="-s -w"
          LDFLAGS="$LDFLAGS -X github.com/tj-smith47/shelly-cli/internal/version.Version=${VERSION}"
          LDFLAGS="$LDFLAGS -X github.com/tj-smith47/shelly-cli/internal/version.Commit=${COMMIT}"
          LDFLAGS="$LDFLAGS -X github.com/tj-smith47/shelly-cli/internal/version.Date=${DATE}"
          LDFLAGS="$LDFLAGS -X github.com/tj-smith47/shelly-cli/internal/version.BuiltBy=github-actions"

          # Add telemetry endpoint if configured
          if [ -n "$TELEMETRY_ENDPOINT" ]; then
            LDFLAGS="$LDFLAGS -X github.com/tj-smith47/shelly-cli/internal/telemetry.Endpoint=${TELEMETRY_ENDPOINT}"
          fi

          BINARY_NAME="shelly"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="shelly.exe"
          fi

          go build -trimpath -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}" ./cmd/shelly

      - name: Generate completions
        shell: bash
        run: |
          mkdir -p dist/completions
          BINARY="dist/shelly"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY="dist/shelly.exe"
          fi
          # Only generate if binary can run on this platform
          if [ "${{ matrix.goos }}" = "$(echo ${{ runner.os }} | tr '[:upper:]' '[:lower:]')" ]; then
            $BINARY completion bash > dist/completions/shelly.bash 2>/dev/null || true
            $BINARY completion zsh > dist/completions/shelly.zsh 2>/dev/null || true
            $BINARY completion fish > dist/completions/shelly.fish 2>/dev/null || true
            $BINARY completion powershell > dist/completions/shelly.ps1 2>/dev/null || true
          fi

      - name: Create archive (Unix)
        if: matrix.goos != 'windows'
        run: |
          cd dist
          tar -czf "../${{ matrix.artifact }}.tar.gz" shelly completions/
          cd ..
          sha256sum "${{ matrix.artifact }}.tar.gz" > "${{ matrix.artifact }}.tar.gz.sha256"

      - name: Create archive (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          cd dist
          Compress-Archive -Path shelly.exe, completions -DestinationPath "../${{ matrix.artifact }}.zip"
          cd ..
          $hash = (Get-FileHash -Algorithm SHA256 "${{ matrix.artifact }}.zip").Hash.ToLower()
          "$hash  ${{ matrix.artifact }}.zip" | Out-File -FilePath "${{ matrix.artifact }}.zip.sha256" -Encoding utf8

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}.*
          retention-days: 1

  # =============================================================================
  # Docker build job
  # =============================================================================
  docker:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: shelly_linux_amd64
          path: artifacts/

      - name: Download Linux arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: shelly_linux_arm64
          path: artifacts/

      - name: Extract binaries
        run: |
          # Extract to paths expected by Dockerfile (linux/amd64, linux/arm64)
          mkdir -p linux/amd64 linux/arm64
          tar -xzf artifacts/shelly_linux_amd64.tar.gz -C linux/amd64
          tar -xzf artifacts/shelly_linux_arm64.tar.gz -C linux/arm64

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/tj-smith47/shelly-cli:${{ needs.prepare.outputs.version }}
            ghcr.io/tj-smith47/shelly-cli:latest
          labels: |
            org.opencontainers.image.title=Shelly CLI
            org.opencontainers.image.description=Command-line interface for Shelly smart home devices
            org.opencontainers.image.url=https://github.com/tj-smith47/shelly-cli
            org.opencontainers.image.source=https://github.com/tj-smith47/shelly-cli
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=Apache-2.0

  # =============================================================================
  # Release job - creates GitHub release with all artifacts
  # =============================================================================
  release:
    needs: [prepare, build, docker]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Move all archives and checksums to release folder
          find artifacts -name "*.tar.gz" -exec mv {} release/ \;
          find artifacts -name "*.zip" -exec mv {} release/ \;
          find artifacts -name "*.sha256" -exec mv {} release/ \;
          # Create combined checksums file
          cd release
          cat *.sha256 > checksums.txt
          ls -la

      - name: Create source archive
        run: |
          git archive --format=tar.gz --prefix=shelly-cli-${{ needs.prepare.outputs.version }}/ \
            -o release/shelly_${{ needs.prepare.outputs.version }}_source.tar.gz HEAD

      - name: Get PR
        uses: 8BitJonny/gh-get-current-pr@3.0.0
        id: pr

      - name: Create Release
        if: ${{ !contains(steps.pr.outputs.pr_title, '[skip') && !contains(steps.pr.outputs.pr_title, 'release]') }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.prepare.outputs.tag }}"
          VERSION="${{ needs.prepare.outputs.version }}"

          # Generate release notes
          cat > release_notes.md << 'EOF'
          ## Installation

          ### Homebrew (macOS)
          ```bash
          brew install tj-smith47/tap/shelly-cli
          ```

          ### Go Install (All Platforms)
          ```bash
          go install github.com/tj-smith47/shelly-cli/cmd/shelly@TAG_PLACEHOLDER
          ```

          ### Docker (Linux)
          ```bash
          docker pull ghcr.io/tj-smith47/shelly-cli:VERSION_PLACEHOLDER
          docker run --rm ghcr.io/tj-smith47/shelly-cli:VERSION_PLACEHOLDER --help
          ```

          ### Download Binary
          Download the appropriate binary for your platform from the assets below.

          ## BLE Support

          | Platform | BLE Discovery | BLE Provisioning |
          |----------|---------------|------------------|
          | Linux | ✅ Requires BlueZ | ✅ |
          | macOS | ✅ Built-in | ✅ |
          | Windows | ✅ Built-in | ✅ |

          ## What's Changed
          See the [CHANGELOG](https://github.com/tj-smith47/shelly-cli/blob/master/CHANGELOG.md) for details.
          EOF

          # Substitute variables
          sed -i "s/TAG_PLACEHOLDER/$TAG/g" release_notes.md
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" release_notes.md

          # Determine if this is a pre-release (contains -rc, -alpha, -beta)
          PRERELEASE_FLAG=""
          if [[ "$TAG" =~ -(rc|alpha|beta) ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          # Create release
          gh release create "$TAG" \
            --title "shelly-cli $TAG" \
            --notes-file release_notes.md \
            $PRERELEASE_FLAG \
            release/*

  # =============================================================================
  # Homebrew tap update
  # =============================================================================
  homebrew:
    needs: [prepare, release]
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: shelly_darwin_amd64
          path: artifacts/darwin_amd64/

      - name: Download macOS arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: shelly_darwin_arm64
          path: artifacts/darwin_arm64/

      - name: Download Linux amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: shelly_linux_amd64
          path: artifacts/linux_amd64/

      - name: Download Linux arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: shelly_linux_arm64
          path: artifacts/linux_arm64/

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="${{ needs.prepare.outputs.tag }}"

          # Get checksums from each artifact directory
          MACOS_AMD64_SHA256=$(cat artifacts/darwin_amd64/shelly_darwin_amd64.tar.gz.sha256 | awk '{print $1}')
          MACOS_ARM64_SHA256=$(cat artifacts/darwin_arm64/shelly_darwin_arm64.tar.gz.sha256 | awk '{print $1}')
          LINUX_AMD64_SHA256=$(cat artifacts/linux_amd64/shelly_linux_amd64.tar.gz.sha256 | awk '{print $1}')
          LINUX_ARM64_SHA256=$(cat artifacts/linux_arm64/shelly_linux_arm64.tar.gz.sha256 | awk '{print $1}')

          # Clone homebrew-tap
          git clone "https://${HOMEBREW_TAP_TOKEN}@github.com/tj-smith47/homebrew-tap.git"
          cd homebrew-tap

          # Create/update formula (shelly-cli installs binary as 'shelly')
          mkdir -p Formula
          rm -f Formula/shelly.rb  # Remove old formula name if exists
          cat > Formula/shelly-cli.rb << EOF
          class ShellyCli < Formula
            desc "Command-line interface for Shelly smart home devices with full BLE support"
            homepage "https://github.com/tj-smith47/shelly-cli"
            license "Apache-2.0"
            version "${VERSION}"

            if OS.mac?
              if Hardware::CPU.intel?
                url "https://github.com/tj-smith47/shelly-cli/releases/download/${TAG}/shelly_darwin_amd64.tar.gz"
                sha256 "${MACOS_AMD64_SHA256}"
              elsif Hardware::CPU.arm?
                url "https://github.com/tj-smith47/shelly-cli/releases/download/${TAG}/shelly_darwin_arm64.tar.gz"
                sha256 "${MACOS_ARM64_SHA256}"
              end
            elsif OS.linux?
              if Hardware::CPU.intel?
                url "https://github.com/tj-smith47/shelly-cli/releases/download/${TAG}/shelly_linux_amd64.tar.gz"
                sha256 "${LINUX_AMD64_SHA256}"
              elsif Hardware::CPU.arm?
                url "https://github.com/tj-smith47/shelly-cli/releases/download/${TAG}/shelly_linux_arm64.tar.gz"
                sha256 "${LINUX_ARM64_SHA256}"
              end
            end

            def install
              bin.install "shelly"

              # Install completions if present
              if File.exist?("completions/shelly.bash")
                bash_completion.install "completions/shelly.bash" => "shelly"
              end
              if File.exist?("completions/shelly.zsh")
                zsh_completion.install "completions/shelly.zsh" => "_shelly"
              end
              if File.exist?("completions/shelly.fish")
                fish_completion.install "completions/shelly.fish"
              end
            end

            test do
              system "#{bin}/shelly", "--version"
            end
          end
          EOF

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A Formula/
          git commit -m "Update shelly-cli to ${VERSION}" || echo "No changes to commit"
          git push
