#!/usr/bin/env bash
# shelly-openhab - Export Shelly devices to OpenHAB configuration
#
# A Shelly CLI plugin that generates OpenHAB Things and Items files
# for registered Shelly devices.
#
# Dependencies:
#   jq - JSON processing
#
# Environment Variables (provided by Shelly CLI):
#   SHELLY_CONFIG_PATH   - Path to config file
#   SHELLY_DEVICES_JSON  - JSON of registered devices
#   SHELLY_OUTPUT_FORMAT - Current output format (table, json, yaml)
#   SHELLY_NO_COLOR      - Set to 1 if colors disabled

set -euo pipefail

VERSION="0.1.0"
SCRIPT_NAME="shelly-openhab"

# Colors (respects SHELLY_NO_COLOR)
if [[ -z "${SHELLY_NO_COLOR:-}" ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    CYAN=''
    NC=''
fi

# Check dependencies
check_dependencies() {
    if ! command -v jq &>/dev/null; then
        echo -e "${RED}Error:${NC} jq is required for this plugin" >&2
        echo "  Install: apt install jq (Debian) or brew install jq (macOS)" >&2
        return 1
    fi
}

# Get device type for OpenHAB binding
get_openhab_thing_type() {
    local gen="$1"
    local type="$2"

    if [[ "$gen" == "1" ]]; then
        case "$type" in
            relay|switch) echo "shelly1" ;;
            plug) echo "shellyplug" ;;
            bulb) echo "shellybulb" ;;
            rgbw2) echo "shellyrgbw2" ;;
            dimmer) echo "shellydimmer" ;;
            *) echo "shelly1" ;;
        esac
    else
        case "$type" in
            switch) echo "shellyplus1" ;;
            plug) echo "shellyplugs" ;;
            light|dimmer) echo "shellyplusdimmer" ;;
            rgbw|rgb) echo "shellyrgbw2" ;;
            cover|roller) echo "shellyplus2pm-roller" ;;
            *) echo "shellyplus1" ;;
        esac
    fi
}

# Generate OpenHAB Things file
generate_things() {
    local output_file="${1:-shelly.things}"
    local devices_json=${SHELLY_DEVICES_JSON:-"{}"}

    echo -e "${CYAN}Generating OpenHAB Things file...${NC}"

    cat > "$output_file" <<'HEADER'
// Shelly Devices Things File
// Generated by shelly-openhab plugin
//
// Add this to your OpenHAB things/ directory
// Requires: Shelly Binding (https://www.openhab.org/addons/bindings/shelly/)

HEADER

    local count=0
    while IFS= read -r device; do
        local name=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].name // $d')
        local ip=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].address // .[$d].ip // .[$d].host // empty')
        local gen=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].generation // "2"')
        local type=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].type // "switch"')
        local model=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].model // empty')

        if [[ -z "$ip" ]]; then
            echo -e "${YELLOW}Warning:${NC} Skipping $device - no IP address" >&2
            continue
        fi

        local thing_type=$(get_openhab_thing_type "$gen" "$type")
        local thing_id=$(echo "$device" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]' '_')

        cat >> "$output_file" <<EOF
// $name${model:+ ($model)}
Thing shelly:${thing_type}:${thing_id} "$name" @ "Shelly" [
    deviceIp="$ip",
    userId="",
    password=""
]

EOF
        ((count++))
    done < <(echo "$devices_json" | jq -r 'keys[]')

    echo -e "${GREEN}✓${NC} Generated $count device(s) to $output_file"
}

# Generate OpenHAB Items file
generate_items() {
    local output_file="${1:-shelly.items}"
    local devices_json=${SHELLY_DEVICES_JSON:-"{}"}

    echo -e "${CYAN}Generating OpenHAB Items file...${NC}"

    cat > "$output_file" <<'HEADER'
// Shelly Devices Items File
// Generated by shelly-openhab plugin
//
// Add this to your OpenHAB items/ directory

Group gShelly "Shelly Devices" <network>
Group gShellyPower "Shelly Power" <energy> (gShelly)

HEADER

    local count=0
    while IFS= read -r device; do
        local name=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].name // $d')
        local type=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].type // "switch"')
        local thing_id=$(echo "$device" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]' '_')
        local item_prefix=$(echo "$device" | tr '[:lower:]' '[:upper:]' | tr -c '[:alnum:]' '_')

        cat >> "$output_file" <<EOF
// $name
Switch ${item_prefix}_Switch "$name" <switch> (gShelly) {channel="shelly:*:${thing_id}:relay#output"}
Number:Power ${item_prefix}_Power "$name Power [%.1f W]" <energy> (gShellyPower) {channel="shelly:*:${thing_id}:meter#currentWatts"}
Number:Energy ${item_prefix}_Energy "$name Energy [%.2f kWh]" <energy> (gShellyPower) {channel="shelly:*:${thing_id}:meter#totalKWH"}

EOF
        ((count++))
    done < <(echo "$devices_json" | jq -r 'keys[]')

    echo -e "${GREEN}✓${NC} Generated $count device(s) to $output_file"
}

# Generate both files
generate_all() {
    local things_file="${1:-shelly.things}"
    local items_file="${2:-shelly.items}"

    generate_things "$things_file"
    generate_items "$items_file"

    echo ""
    echo -e "${CYAN}Next steps:${NC}"
    echo "  1. Copy $things_file to <openhab>/conf/things/"
    echo "  2. Copy $items_file to <openhab>/conf/items/"
    echo "  3. Update credentials in .things file if auth is enabled"
    echo "  4. Install Shelly Binding if not already installed"
}

# List devices that would be exported
list_devices() {
    local devices_json=${SHELLY_DEVICES_JSON:-"{}"}

    echo -e "${CYAN}Devices available for export:${NC}"
    echo ""

    local count=0
    while IFS= read -r device; do
        local name=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].name // $d')
        local ip=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].address // .[$d].ip // .[$d].host // "unknown"')
        local gen=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].generation // "2"')
        local type=$(echo "$devices_json" | jq -r --arg d "$device" '.[$d].type // "switch"')

        printf "  %-20s %-15s Gen%s %-10s\n" "$name" "$ip" "$gen" "$type"
        ((count++))
    done < <(echo "$devices_json" | jq -r 'keys[]')

    echo ""
    echo "Total: $count device(s)"
}

# Show help
show_help() {
    cat <<EOF
${CYAN}shelly-openhab${NC} - Export Shelly devices to OpenHAB configuration

${YELLOW}Usage:${NC}
    shelly openhab <command> [options]

${YELLOW}Commands:${NC}
    things [file]     Generate OpenHAB Things file (default: shelly.things)
    items [file]      Generate OpenHAB Items file (default: shelly.items)
    all [dir]         Generate both Things and Items files
    list              List devices that would be exported
    help              Show this help
    version           Show version

${YELLOW}Options:${NC}
    -h, --help        Show help
    -v, --version     Show version

${YELLOW}Examples:${NC}
    # Generate all configuration files
    shelly openhab all

    # Generate only Things file
    shelly openhab things my-shelly.things

    # Generate to specific directory
    shelly openhab all /etc/openhab/conf/

    # List available devices
    shelly openhab list

${YELLOW}OpenHAB Setup:${NC}
    1. Install the Shelly Binding from the OpenHAB UI
       (Settings -> Add-ons -> Bindings -> Shelly)
    2. Run 'shelly openhab all' to generate configuration
    3. Copy generated files to your OpenHAB conf/ directory
    4. Update device credentials if authentication is enabled

${YELLOW}Requirements:${NC}
    - OpenHAB 3.x or 4.x
    - Shelly Binding installed
    - jq (for JSON processing)
EOF
}

# Show version
show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Main entry point
main() {
    check_dependencies || exit 1

    local cmd="${1:-help}"

    case "$cmd" in
    -h | --help | help)
        show_help
        ;;
    -v | --version | version)
        show_version
        ;;
    things)
        shift
        generate_things "${1:-shelly.things}"
        ;;
    items)
        shift
        generate_items "${1:-shelly.items}"
        ;;
    all)
        shift
        if [[ -n "${1:-}" && -d "$1" ]]; then
            generate_all "$1/shelly.things" "$1/shelly.items"
        else
            generate_all "${1:-shelly.things}" "${2:-shelly.items}"
        fi
        ;;
    list)
        list_devices
        ;;
    *)
        echo -e "${RED}Error:${NC} Unknown command: $cmd" >&2
        echo "Run 'shelly openhab help' for usage" >&2
        exit 1
        ;;
    esac
}

main "$@"
